<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¼ºå¾·åœ°å›¾ Â· é«˜å¾·2.0 æ»¡è¡€ç‰ˆ</title>
    <!-- é«˜å¾· JS API 2.0ï¼ˆHTTPS ä¸‹å®Œç¾è¿è¡Œï¼‰ -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=a95ddc6e86de2e40f7ad74dfd19f9633"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body, html { width: 100%; height: 100%; overflow: hidden; font-family: 'PingFang SC', sans-serif; }
        #map { width: 100%; height: 100%; background: #c8e0f0; }

        /* ----- æ™®é€šæ¨¡å¼ UI (æ¨¡ä»¿é«˜å¾·ä¸»é¡µ) ----- */
        .normal-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .search-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 80px;
            height: 48px;
            background: white;
            border-radius: 24px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            pointer-events: auto;
            z-index: 100;
        }
        .search-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
        }
        .search-btn {
            width: 40px;
            height: 40px;
            background: #0a7bff;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
            font-size: 18px;
            cursor: pointer;
        }
        .right-toolbar {
            position: absolute;
            right: 16px;
            top: 20px;
            width: 52px;
            pointer-events: auto;
            z-index: 100;
        }
        .tool-btn {
            width: 52px;
            height: 52px;
            background: white;
            border-radius: 50%;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            color: #333;
        }
        .tool-btn span { font-size: 12px; margin-top: 2px; }

        /* ----- å¯¼èˆªæ¨¡å¼ UI (é»˜è®¤éšè—) ----- */
        .nav-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: none;
            z-index: 200;
        }
        .nav-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            pointer-events: auto;
        }
        .nav-exit {
            width: 44px;
            height: 44px;
            background: rgba(255,255,255,0.9);
            border-radius: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            backdrop-filter: blur(5px);
        }
        .nav-info-card {
            position: absolute;
            bottom: 100px;
            left: 16px;
            right: 16px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            pointer-events: auto;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }
        .nav-route-info {
            font-size: 18px;
            font-weight: bold;
            color: #0a7bff;
            margin-bottom: 8px;
        }
        .nav-next-action {
            font-size: 16px;
            color: #333;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        /* ----- åº•éƒ¨é€šç”¨éŸ³ä¹æ’­æ”¾å™¨ (æ‚¬æµ®) ----- */
        .music-player {
            position: absolute;
            bottom: 20px;
            left: 16px;
            right: 16px;
            background: white;
            border-radius: 16px;
            padding: 16px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            pointer-events: auto;
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
            z-index: 300;
        }
        .music-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .song-info {
            display: flex;
            flex-direction: column;
        }
        .song-title { font-size: 16px; font-weight: 600; color: #222; }
        .song-artist { font-size: 12px; color: #777; }
        .play-btn {
            width: 48px;
            height: 48px;
            background: #0a7bff;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
        }
        .lyrics {
            margin-top: 8px;
            font-size: 13px;
            color: #555;
            white-space: nowrap;
            overflow-x: auto;
            padding: 4px 0;
            border-top: 1px solid #f0f0f0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- æ™®é€šæ¨¡å¼ç•Œé¢ -->
    <div class="normal-ui" id="normalUI">
        <div class="search-bar">
            <input type="text" id="keyword" class="search-input" placeholder="æœç´¢åœ°ç‚¹ï¼ˆå¦‚ï¼šå¤©å®‰é—¨ï¼‰">
            <div class="search-btn" id="searchBtn">ğŸ”</div>
        </div>
        <div class="right-toolbar">
            <div class="tool-btn" id="zoomIn"><div>+</div><span>æ”¾å¤§</span></div>
            <div class="tool-btn" id="zoomOut"><div>-</div><span>ç¼©å°</span></div>
            <div class="tool-btn" id="locateBtn"><div>ğŸ“</div><span>å®šä½</span></div>
            <div class="tool-btn" id="navBtn"><div>ğŸš—</div><span>å¯¼èˆª</span></div>
        </div>
    </div>

    <!-- å¯¼èˆªæ¨¡å¼ç•Œé¢ -->
    <div class="nav-ui" id="navUI">
        <div class="nav-header">
            <div class="nav-exit" id="exitNavBtn">â†</div>
            <div style="width:44px;"></div>
        </div>
        <div class="nav-info-card" id="navInfoCard">
            <div class="nav-route-info" id="navRouteInfo">å…¨ç¨‹ -- kmï¼Œ--åˆ†é’Ÿ</div>
            <div class="nav-next-action" id="navNextAction">å‡†å¤‡è·¯çº¿ä¸­...</div>
            <div style="display: flex; justify-content: space-between; color: #666; font-size: 14px;">
                <span id="navRemainDist">ğŸš¥ å‰©ä½™ -- km</span>
                <span id="navArriveTime">ğŸ•’ --:--</span>
            </div>
        </div>
    </div>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ï¼ˆå§‹ç»ˆå¯è§ï¼‰ -->
    <div class="music-player">
        <div class="music-row">
            <div class="song-info">
                <span class="song-title" id="songTitle">ä¸€è·¯å‘åŒ—</span>
                <span class="song-artist" id="songArtist">å‘¨æ°ä¼¦</span>
            </div>
            <div class="play-btn" id="playPauseBtn">â–¶ï¸</div>
        </div>
        <div class="lyrics" id="lyricText">ğŸ¤ ç­‰å¾…æ’­æ”¾æˆ–æœç´¢æ­Œæ›²</div>
    </div>

    <script>
        // ========== å…¨å±€å˜é‡ ==========
        let map, geolocation, placeSearch, driving;
        let currentPos = [116.397428, 39.90923]; // é»˜è®¤åŒ—äº¬
        let destination = null;
        let destName = '';
        let marker, destMarker;
        let audio = new Audio();
        let isPlaying = false;
        let songId = null;
        let lyricArray = [];
        let lyricTimer = null;
        let currentRoute = null;

        // ========== åˆå§‹åŒ–åœ°å›¾ ==========
        window.onload = function() {
            map = new AMap.Map('map', {
                zoom: 14,
                center: currentPos
            });

            // åŠ è½½æ’ä»¶
            AMap.plugin(['AMap.Geolocation', 'AMap.PlaceSearch', 'AMap.Driving'], function() {
                geolocation = new AMap.Geolocation({
                    enableHighAccuracy: true,
                    timeout: 10000,
                    zoomToAccuracy: true
                });
                placeSearch = new AMap.PlaceSearch({ map: map, city: 'å…¨å›½' });
                driving = new AMap.Driving({ map: map });

                // è‡ªåŠ¨å®šä½
                autoLocate();
            });

            bindEvents();
            searchMusic('ä¸€è·¯å‘åŒ—');
        };

        // ========== å®šä½ ==========
        function autoLocate() {
            if (!geolocation) return;
            geolocation.getCurrentPosition(function(status, result) {
                if (status === 'complete') {
                    currentPos = [result.position.lng, result.position.lat];
                    map.setCenter(currentPos);
                    if (marker) marker.setMap(null);
                    marker = new AMap.Marker({
                        position: currentPos,
                        map: map,
                        title: 'æˆ‘çš„ä½ç½®'
                    });
                } else {
                    console.log('å®šä½å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤ä½ç½®');
                }
            });
        }

        // ========== åœ°ç‚¹æœç´¢ ==========
        function searchPlace(keyword) {
            if (!keyword.trim()) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }
            placeSearch.search(keyword, function(status, result) {
                if (status === 'complete' && result.poiList.pois.length > 0) {
                    let poi = result.poiList.pois[0];
                    let lnglat = poi.location;
                    destination = [lnglat.lng, lnglat.lat];
                    destName = poi.name;
                    if (destMarker) destMarker.setMap(null);
                    destMarker = new AMap.Marker({
                        position: destination,
                        map: map,
                        title: poi.name,
                        label: { content: poi.name, offset: new AMap.Pixel(0, -25) }
                    });
                    map.setCenter(destination);
                    map.setZoom(15);
                    document.getElementById('keyword').value = poi.name; // å›æ˜¾
                } else {
                    alert('æœªæ‰¾åˆ°åœ°ç‚¹ï¼Œè¯·å°è¯•æ›´å…·ä½“çš„å…³é”®è¯');
                }
            });
        }

        // ========== é©¾è½¦è·¯çº¿è§„åˆ’ ==========
        function planRoute() {
            if (!destination) {
                alert('è¯·å…ˆæœç´¢ç›®çš„åœ°');
                return;
            }
            driving.search(currentPos, destination, function(status, result) {
                if (status === 'complete' && result.routes.length) {
                    currentRoute = result.routes[0];
                    let dist = (currentRoute.distance / 1000).toFixed(1);
                    let time = Math.ceil(currentRoute.time / 60);
                    document.getElementById('navRouteInfo').innerText = `å…¨ç¨‹ ${dist} kmï¼Œ${time} åˆ†é’Ÿ`;
                    if (currentRoute.steps && currentRoute.steps.length) {
                        let firstStep = currentRoute.steps[0];
                        document.getElementById('navNextAction').innerText = firstStep.instruction || 'å‰æ–¹300ç±³å³è½¬';
                    } else {
                        document.getElementById('navNextAction').innerText = 'æ²¿å½“å‰é“è·¯è¡Œé©¶';
                    }
                    document.getElementById('navRemainDist').innerText = `ğŸš¥ å‰©ä½™ ${dist} km`;
                    let now = new Date();
                    now.setMinutes(now.getMinutes() + time);
                    let arriveStr = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
                    document.getElementById('navArriveTime').innerText = `ğŸ•’ ${arriveStr}`;
                    enterNavMode();
                } else {
                    alert('è·¯çº¿è§„åˆ’å¤±è´¥');
                }
            });
        }

        // ========== åˆ‡æ¢å¯¼èˆªæ¨¡å¼ ==========
        function enterNavMode() {
            document.getElementById('normalUI').style.display = 'none';
            document.getElementById('navUI').style.display = 'block';
        }

        function exitNavMode() {
            document.getElementById('normalUI').style.display = 'block';
            document.getElementById('navUI').style.display = 'none';
        }

        // ========== éŸ³ä¹åŠŸèƒ½ ==========
        function searchMusic(songName) {
            let url = `https://api.injahow.cn/meting/?server=netease&type=search&input=${encodeURIComponent(songName)}`;
            fetch(url).then(r => r.json()).then(data => {
                if (data.length) {
                    let song = data[0];
                    songId = song.id;
                    document.getElementById('songTitle').innerText = song.name;
                    document.getElementById('songArtist').innerText = song.artist;
                    return fetch(`https://api.injahow.cn/meting/?server=netease&type=url&id=${songId}`);
                }
            }).then(r => r.json()).then(urlData => {
                if (urlData.url) {
                    audio.src = urlData.url;
                    return fetch(`https://api.injahow.cn/meting/?server=netease&type=lrc&id=${songId}`);
                }
            }).then(r => r.text()).then(lrc => {
                parseLyrics(lrc);
                document.getElementById('lyricText').innerText = 'ğŸµ å·²åŠ è½½ï¼Œç‚¹å‡»æ’­æ”¾';
            }).catch(e => console.log('éŸ³ä¹åŠ è½½å¤±è´¥', e));
        }

        function parseLyrics(lrc) {
            lyricArray = [];
            let lines = lrc.split('\n');
            let reg = /\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;
            lines.forEach(line => {
                let m = reg.exec(line);
                if (m) {
                    let time = parseInt(m[1])*60 + parseInt(m[2]) + parseInt(m[3].padEnd(3,'0'))/1000;
                    let text = m[4].trim();
                    if (text) lyricArray.push({time, text});
                }
            });
            lyricArray.sort((a,b) => a.time - b.time);
        }

        function togglePlay() {
            if (!audio.src) {
                searchMusic('ä¸€è·¯å‘åŒ—');
                setTimeout(togglePlay, 800);
                return;
            }
            if (isPlaying) {
                audio.pause();
                document.getElementById('playPauseBtn').innerHTML = 'â–¶ï¸';
                clearInterval(lyricTimer);
            } else {
                audio.play().then(() => {
                    document.getElementById('playPauseBtn').innerHTML = 'â¸ï¸';
                    startLyricUpdate();
                }).catch(e => alert('è¯·å…ˆç‚¹å‡»é¡µé¢'));
            }
            isPlaying = !isPlaying;
        }

        function startLyricUpdate() {
            if (lyricTimer) clearInterval(lyricTimer);
            lyricTimer = setInterval(() => {
                if (!audio.currentTime || !lyricArray.length) return;
                let t = audio.currentTime;
                let line = '';
                for (let i = lyricArray.length-1; i>=0; i--) {
                    if (t >= lyricArray[i].time) { line = lyricArray[i].text; break; }
                }
                if (line) document.getElementById('lyricText').innerText = line;
            }, 300);
        }

        // ========== äº‹ä»¶ç»‘å®š ==========
        function bindEvents() {
            document.getElementById('searchBtn').onclick = function() {
                let kw = document.getElementById('keyword').value;
                searchPlace(kw);
            };
            document.getElementById('keyword').onkeypress = function(e) {
                if (e.key === 'Enter') document.getElementById('searchBtn').click();
            };
            document.getElementById('zoomIn').onclick = function() { map.zoomIn(); };
            document.getElementById('zoomOut').onclick = function() { map.zoomOut(); };
            document.getElementById('locateBtn').onclick = function() { autoLocate(); };
            document.getElementById('navBtn').onclick = function() {
                if (destination) planRoute(); else alert('è¯·å…ˆæœç´¢ç›®çš„åœ°');
            };
            document.getElementById('exitNavBtn').onclick = function() { exitNavMode(); };
            document.getElementById('playPauseBtn').onclick = function() { togglePlay(); };
            audio.onended = function() {
                isPlaying = false;
                document.getElementById('playPauseBtn').innerHTML = 'â–¶ï¸';
                clearInterval(lyricTimer);
            };
        }
    </script>
</body>
</html>
